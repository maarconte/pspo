rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Helper functions
    function isAuthenticated() {
      return request.auth != null;
    }

    function getUserRole() {
      return request.auth.token.role;
    }

    function isDev() {
      return isAuthenticated() && getUserRole() == 'dev';
    }

    function isAdmin() {
      return isAuthenticated() && (getUserRole() == 'admin' || getUserRole() == 'dev');
    }

    // Users collection
    match /users/{userId} {
      allow read: if isAuthenticated() && (request.auth.uid == userId || isDev());
      allow write: if isAuthenticated() && request.auth.uid == userId;

      // Created sessions (historique du créateur)
      match /createdSessions/{sessionId} {
        allow read, write: if isAuthenticated() && request.auth.uid == userId;
      }
    }

    // Questions collection
    match /questions/{questionId} {
      allow read: if true;
      allow create, update, delete: if isAdmin();
    }

    // Categories collection
    match /categories/{categoryId} {
      allow read: if true;
      allow create, update, delete: if isAdmin();
    }

    // Quiz sessions collection (anciennes sessions individuelles)
    match /quizSessions/{sessionId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update, delete: if isAuthenticated() &&
        resource.data.userId == request.auth.uid;
    }

    // ===== COLLABORATIVE SESSIONS =====

  // Sessions : lecture publique (même anonyme), création par authentifiés, modification par créateur
  match /sessions/{sessionId} {
    allow read: if true; // Tout le monde peut lire une session (même anonyme)
    allow create: if isAuthenticated(); // Seuls les utilisateurs authentifiés peuvent créer
    // Permettre à tout le monde d'incrémenter participantCount (pour rejoindre)
    // Seul le créateur peut modifier les autres champs
    allow update: if (
      // Tout le monde peut incrémenter participantCount
      (request.resource.data.diff(resource.data).affectedKeys().hasOnly(['participantCount']))
      ||
      // Le créateur peut tout modifier
      (isAuthenticated() && resource.data.creatorId == request.auth.uid)
    );
    allow delete: if isAuthenticated() &&
      resource.data.creatorId == request.auth.uid; // Seul le créateur peut modifier/supprimer

    // Participants : lecture publique, création libre (même anonyme), modification par le participant
    match /participants/{participantId} {
      allow read: if true; // Tout le monde peut voir les participants (même anonyme)
      allow create: if true; // N'importe qui peut rejoindre (même anonyme)
      allow update: if true; // Permettre la mise à jour (pour les réponses)
      allow delete: if isAuthenticated() &&
        get(/databases/$(database)/documents/sessions/$(sessionId)).data.creatorId == request.auth.uid; // Seul le créateur peut supprimer
    }

    // Leaderboard : lecture publique (même anonyme), écriture par créateur
    match /leaderboard/{questionIndex} {
      allow read: if true; // Tout le monde peut voir le classement (même anonyme)
      allow write: if isAuthenticated() &&
        get(/databases/$(database)/documents/sessions/$(sessionId)).data.creatorId == request.auth.uid; // Seul le créateur peut mettre à jour
    }
  }
  }
}
